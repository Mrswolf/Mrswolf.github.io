<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=5,viewport-fit=cover"><title>Makefile使用规则 | swolf的博客</title><meta name="description" content="出于工作需要，我要开始系统学习c++了。目前我的主力台式机是Linux系统，最常用的编辑器是VS Code，所以想要得到一个比较完整的C&#x2F;C++工程方案，似乎学习Makefile的相关规则是必不可少的。"><meta property="og:type" content="article"><meta property="og:title" content="Makefile使用规则"><meta property="og:url" content="https://mrswolf.github.io/learn-makefile/index.html"><meta property="og:site_name" content="swolf的博客"><meta property="og:description" content="出于工作需要，我要开始系统学习c++了。目前我的主力台式机是Linux系统，最常用的编辑器是VS Code，所以想要得到一个比较完整的C&#x2F;C++工程方案，似乎学习Makefile的相关规则是必不可少的。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-06-06T16:00:00.000Z"><meta property="article:modified_time" content="2022-06-08T14:01:42.072Z"><meta property="article:author" content="swolf"><meta property="article:tag" content="c++"><meta property="article:tag" content="linux"><meta name="twitter:card" content="summary"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><meta name="google-site-verification" content="dN2SLd9-x4zqC5VsgpROSppupvj3_eOvkDfKG32YSdc"><meta name="msvalidate.01" content="0735A9B44239360B87417963B55FE980"><link rel="stylesheet" href="/css/iconfont.min.css"><link rel="stylesheet" href="/css/common.min.css"><link href="//cdn.staticfile.org/KaTeX/0.15.6/katex.min.css" rel="stylesheet" crossorigin="anonymous"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2JPFK1G1RZ"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2JPFK1G1RZ")</script><meta name="generator" content="Hexo 6.1.0"></head><body><header class="header header-fixture"><div class="profile-search-wrap flex sm:block"><div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6"><a id="avatar" role="link" href="https://github.com/mrswolf" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer"><img src="/images/avatar.jpg" class="rounded-full" alt="avatar"></a><h2 id="name" class="hidden lg:block">swolf</h2><h3 id="title" class="hidden xl:block">PhD &amp; Engineer &amp; Coder</h3><small id="location" class="hidden lg:block"><i class="iconfont icon-map-icon"></i> Earth, Universe</small></div><div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full"><form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200"><div class="input-group table bg-gray-100 lg:bg-white w-full"><input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white"> <span class="table-cell"><button name="search tigger button" disabled><i class="iconfont icon-search m-2"></i></button></span></div></form><div id="content-json" data-placeholder="Search" class="invisible hidden">/content.json</div><script id="search-teamplate" type="text/html" data-path="/content.json"><div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div></script></div><button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false"><i class="iconfont icon-hamburger"></i></button></div><nav id="menu-nav" class="hidden sm:flex flex-col"><div class="menu-item menu-home" role="menuitem"><a href="/."><i class="iconfont icon-home" aria-hidden="true"></i> <span class="menu-title">Home</span></a></div><div class="menu-item menu-archives" role="menuitem"><a href="/archives"><i class="iconfont icon-archive" aria-hidden="true"></i> <span class="menu-title">Archives</span></a></div><div class="menu-item menu-categories" role="menuitem"><a href="/categories"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Categories</span></a></div><div class="menu-item menu-tags" role="menuitem"><a href="/tags"><i class="iconfont icon-tag" aria-hidden="true"></i> <span class="menu-title">Tags</span></a></div><div class="menu-item menu-repository" role="menuitem"><a href="/repository"><i class="iconfont icon-project" aria-hidden="true"></i> <span class="menu-title">Repository</span></a></div><div class="menu-item menu-publications" role="menuitem"><a href="/publications"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Publications</span></a></div><div class="menu-item menu-about" role="menuitem"><a href="/about"><i class="iconfont icon-cup" aria-hidden="true"></i> <span class="menu-title">About</span></a></div><div class="social-links flex sm:flex-col lg:hidden mt-5"><span class="social-item text-center"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont social-icon icon-github"></i> <span class="menu-title hidden lg:inline">menu.github</span> </a></span><span class="social-item text-center"><a href="/atom.xml"><i class="iconfont social-icon icon-rss"></i> <span class="menu-title hidden lg:inline">menu.rss</span></a></span></div></nav></header><section class="main-section"><main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen"><article class="content article article-archives article-type-list" itemscope><header class="article-header"><h1 itemprop="name text-lg"><a class="article-title" href="/learn-makefile" target="_blank" itemprop="url">Makefile使用规则</a></h1><p class="article-meta mb-3 text-xs"><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2022-06-06T16:00:00.000Z" itemprop="datePublished">Jun7, 2022</time></span><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2022-06-08T14:01:42.072Z" itemprop="datePublished">Jun8, 2022</time></span><span class="article-category"><i class="iconfont icon-folder"></i> <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a> </span><span class="article-tags"><i class="iconfont icon-tag"></i> <a class="article-tag-none-link" href="/tags/c/" rel="tag">c++</a>, <a class="article-tag-none-link" href="/tags/linux/" rel="tag">linux</a> </span><span class="_partial/post-comment"><i class="icon icon-comment"></i> <a href="/learn-makefile/#comments" class="article-comment-link">Comments </a></span><span class="post-wordcount" itemprop="wordCount">Word Count: 1.1k(words)</span> <span class="post-readcount" itemprop="timeRequired">Read Count: 4(minutes)</span></p></header><div class="marked-body article-body"><p>出于工作需要，我要开始系统学习c++了。目前我的主力台式机是Linux系统，最常用的编辑器是VS Code，所以想要得到一个比较完整的C/C++工程方案，似乎学习Makefile的相关规则是必不可少的。<span id="more"></span>本文的内容主要源于<a target="_blank" rel="noopener" href="https://makefiletutorial.com/">makefile tutorial by example</a>（感谢作者大大）。</p><h3 id="为什么要使用makefile">为什么要使用makefile</h3><p>对于大型C/C++项目而言，完整的程序功能往往是很多子模块组合得到的。试想开发者改变或添加了几个新的功能，如果手动重新编译整个项目（比如在shell里输入一长串的g++命令以及一堆的lib），不仅费时费力、还容易出错。make工具正是用来处理这种某些模型源代码文件需要重新编译的情况，它所依赖的配置文件就是Makefile。简而言之，make通过预先配置好的Makefile，按一定的规则负责处理C/C++项目的编译，从而得到最终的可执行程序。目前，大多数开源项目都会提供Makefile，开发者可以很方便的调用<code>make</code>命令编译整个开源项目。</p><p>当然，make并不是唯一用于处理C/C++项目编译的解决方案，一些替代的解决方案包括<a target="_blank" rel="noopener" href="https://cmake.org">CMake</a>、<a target="_blank" rel="noopener" href="https://bazel.build/">Bazel</a>等等。在Windows平台上，Visual Studio也有其内置的build工具。</p><p>本篇所使用的make是指GNU make，在Linux和MacOS上是默认安装的make实现。</p><h3 id="基本语法">基本语法</h3><p>现在我们来创建一个最简单的Makefile。首先在任何目录下创建一个名为<code>Makefile</code>的文件（注意文件名就是Makefile，大些的M，也没有类似.txt的后缀），然后在其中输入这些文本：</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">hello:</span></span><br><span class="line">	echo <span class="string">&quot;hello make&quot;</span></span><br></pre></td></tr></table></figure><p>注意，Makefile的缩进只能是Tab，不可以用空格，不然<code>make</code>会报缺失分隔符错误，要小心你的编辑器是不是自动将Tab缩进转换成了4个空格。接下来在该目录下的terminal里运行<code>make</code>命令，输出如下：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">echo &quot;hello make&quot;</span><br><span class="line">hello make</span><br></pre></td></tr></table></figure><p>表明需要执行<code>echo &quot;hello make&quot;</code>命令，执行结果是<code>hello make</code>。</p><p>Makefile文件是由一系列rule组成的，一个rule定义如下：</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">targets: prerequisties</span></span><br><span class="line">    command</span><br><span class="line">    command</span><br><span class="line">    command</span><br></pre></td></tr></table></figure><p><code>targets</code>是本次操作希望达成的目标，它实质是一系列文件名，相互之间用空格隔开，通常只有一个文件名，比如例子中的<code>hello</code>文件，而每一行的<code>command</code>则是用来达成<code>targets</code>的手段，通过执行<code>command</code>，我们希望在所有命令执行完成后能够产生<code>targets</code>所规定的文件。<code>prerequisties</code>同样也是一系列文件名，相互之间用空格隔开，它表示执行命令前这些文件应当已经存在了，有些类似程序的依赖概念。一个rule可以简单理解为在<code>prerequisties</code>存在的情况下，运行一系列<code>command</code>，希望最终能够得到<code>targets</code>中的文件。</p><h3 id="基本执行关系">基本执行关系</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">blah: blah.o</span></span><br><span class="line">	gcc blah.o -o blah <span class="comment"># Runs third</span></span><br><span class="line"></span><br><span class="line"><span class="section">blah.o: blah.c</span></span><br><span class="line">	gcc -c blah.c -o blah.o <span class="comment"># Runs second</span></span><br><span class="line"></span><br><span class="line"><span class="section">blah.c:</span></span><br><span class="line">	echo <span class="string">&quot;int main() &#123; return 0; &#125;&quot;</span> &gt; blah.c <span class="comment"># Runs first</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f blah blah.o blah.c</span><br></pre></td></tr></table></figure><p>上面是一个有四个rule的Makefile文件，不指定target情况下，运行<code>make</code>会默认以第一个rule中的targets为目标，从而进行如下操作：</p><ul><li>第一个rule想产生名为<code>blah</code>的文件，但是需要文件<code>blah.o</code>，所以跳转到第二个rule</li><li>第二个rule又需要文件<code>blah.c</code>，所以跳转到第三个rule</li><li>第三个rule为了产生<code>blah.c</code>，执行命令产生一个blah.c文件，接着返回第二个rule</li><li>现在有了<code>blah.c</code>，第二个rule编译生成<code>blah.o</code>二进制文件，接着返回第一个rule</li><li>现在有了<code>blah.o</code>，第一个rule链接生成<code>blah</code>可执行文件，任务完成</li></ul><p>现在我们的目录下已经有<code>blah</code>文件了，所以再运行一次<code>make</code>不会产生任何效果。注意到<code>blah</code>目标的产生与<code>clean</code>无关，所以<code>clean</code>所代表的rule不会执行，不过可以显式运行<code>make clean</code>命令来调用该rule规定的清理文件操作。</p><p>最后需要注意的是，<code>make</code>似乎只会检查一次<code>targets</code>和<code>prerequisties</code>是否存在，至于调用之后是不是成功产生了目标文件，<code>make</code>是不会去检查的，而是默认成功了。</p><p>TODO</p></div><blockquote class="copyright"><p><strong>Link to this article : </strong><a class="permalink" href="https://mrswolf.github.io/learn-makefile/">https://mrswolf.github.io/learn-makefile/</a></p><p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p></blockquote></article></main><aside id="sidebar" class="aside aside-fixture"><div class="toc-sidebar"><nav id="toc" class="article-toc"><h3 class="toc-title">Catalogue</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8makefile"><span class="toc-number">1.</span> <span class="toc-text">为什么要使用makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%85%B3%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">基本执行关系</span></a></li></ol></nav></div></aside></section><footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40"><div class="footer-social-links"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont icon-github"></i> </a><a href="/atom.xml"><i class="iconfont icon-rss"></i></a></div></footer><div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div><div id="search-view-container" class="hidden shadow-xl"></div><script src="/js/dom-event.min.js"></script><script src="/js/local-search.min.js"></script><script src="//cdn.staticfile.org/lightgallery-js/1.1.3/js/lightgallery.min.js"></script><script src="/js/light-gallery.min.js"></script></body></html>