<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=5,viewport-fit=cover"><title>MATLAB分布式集群搭建记录 | swolf的博客</title><meta name="description" content="本篇的内容可能过时啦 虽然我很久不用MATLAB处理日常工作，但是实验室主流依然是MATLAB（用Python的就那么几个T_T)。以前小伙伴们跑程序都是拷贝程序和数据到实验室的计算服务器上，手工开N个MATLAB窗口做运算。现在实验室规模扩大，这种手工的方式越来越繁琐。我从前用MATLAB时就想试试集群计算，奈何当时实验室没啥硬件条件，正好现在有机会，我干脆搭了个MATLAB集群供小伙伴使用。"><meta property="og:type" content="article"><meta property="og:title" content="MATLAB分布式集群搭建记录"><meta property="og:url" content="https://mrswolf.github.io/matlab-mdce-log/index.html"><meta property="og:site_name" content="swolf的博客"><meta property="og:description" content="本篇的内容可能过时啦 虽然我很久不用MATLAB处理日常工作，但是实验室主流依然是MATLAB（用Python的就那么几个T_T)。以前小伙伴们跑程序都是拷贝程序和数据到实验室的计算服务器上，手工开N个MATLAB窗口做运算。现在实验室规模扩大，这种手工的方式越来越繁琐。我从前用MATLAB时就想试试集群计算，奈何当时实验室没啥硬件条件，正好现在有机会，我干脆搭了个MATLAB集群供小伙伴使用。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://mrswolf.github.io/matlab-mdce-log/license.png"><meta property="og:image" content="https://mrswolf.github.io/matlab-mdce-log/nfs.png"><meta property="og:image" content="https://mrswolf.github.io/matlab-mdce-log/connectivity.png"><meta property="og:image" content="https://mrswolf.github.io/matlab-mdce-log/center.png"><meta property="article:published_time" content="2019-05-19T16:00:00.000Z"><meta property="article:modified_time" content="2022-03-20T16:00:00.000Z"><meta property="article:author" content="swolf"><meta property="article:tag" content="matlab"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mrswolf.github.io/matlab-mdce-log/license.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><meta name="google-site-verification" content="dN2SLd9-x4zqC5VsgpROSppupvj3_eOvkDfKG32YSdc"><meta name="msvalidate.01" content="0735A9B44239360B87417963B55FE980"><link rel="stylesheet" href="/css/iconfont.min.css"><link rel="stylesheet" href="/css/common.min.css"><link href="//cdn.staticfile.org/KaTeX/0.15.6/katex.min.css" rel="stylesheet" crossorigin="anonymous"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2JPFK1G1RZ"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2JPFK1G1RZ")</script><meta name="generator" content="Hexo 6.1.0"></head><body><header class="header header-fixture"><div class="profile-search-wrap flex sm:block"><div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6"><a id="avatar" role="link" href="https://github.com/mrswolf" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer"><img src="/images/avatar.jpg" class="rounded-full" alt="avatar"></a><h2 id="name" class="hidden lg:block">swolf</h2><h3 id="title" class="hidden xl:block">Engineer &amp; Coder &amp; Researcher</h3><small id="location" class="hidden lg:block"><i class="iconfont icon-map-icon"></i> Earth, Universe</small></div><div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full"><form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200"><div class="input-group table bg-gray-100 lg:bg-white w-full"><input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white"> <span class="table-cell"><button name="search tigger button" disabled><i class="iconfont icon-search m-2"></i></button></span></div></form><div id="content-json" data-placeholder="Search" class="invisible hidden">/content.json</div><script id="search-teamplate" type="text/html" data-path="/content.json"><div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div></script></div><button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false"><i class="iconfont icon-hamburger"></i></button></div><nav id="menu-nav" class="hidden sm:flex flex-col"><div class="menu-item menu-home" role="menuitem"><a href="/."><i class="iconfont icon-home" aria-hidden="true"></i> <span class="menu-title">Home</span></a></div><div class="menu-item menu-archives" role="menuitem"><a href="/archives"><i class="iconfont icon-archive" aria-hidden="true"></i> <span class="menu-title">Archives</span></a></div><div class="menu-item menu-categories" role="menuitem"><a href="/categories"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Categories</span></a></div><div class="menu-item menu-tags" role="menuitem"><a href="/tags"><i class="iconfont icon-tag" aria-hidden="true"></i> <span class="menu-title">Tags</span></a></div><div class="menu-item menu-repository" role="menuitem"><a href="/repository"><i class="iconfont icon-project" aria-hidden="true"></i> <span class="menu-title">Repository</span></a></div><div class="menu-item menu-publications" role="menuitem"><a href="/publications"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Publications</span></a></div><div class="menu-item menu-about" role="menuitem"><a href="/about"><i class="iconfont icon-cup" aria-hidden="true"></i> <span class="menu-title">About</span></a></div><div class="social-links flex sm:flex-col lg:hidden mt-5"><span class="social-item text-center"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont social-icon icon-github"></i> <span class="menu-title hidden lg:inline">menu.github</span> </a></span><span class="social-item text-center"><a href="/atom.xml"><i class="iconfont social-icon icon-rss"></i> <span class="menu-title hidden lg:inline">menu.rss</span></a></span></div></nav></header><section class="main-section"><main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen"><article class="content article article-archives article-type-list" itemscope><header class="article-header"><h1 itemprop="name text-lg"><a class="article-title" href="/matlab-mdce-log" target="_blank" itemprop="url">MATLAB分布式集群搭建记录</a></h1><p class="article-meta mb-3 text-xs"><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2019-05-19T16:00:00.000Z" itemprop="datePublished">May20, 2019</time></span><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2022-03-20T16:00:00.000Z" itemprop="datePublished">Mar21, 2022</time></span><span class="article-category"><i class="iconfont icon-folder"></i> <a class="article-category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/">分布式计算</a> </span><span class="article-tags"><i class="iconfont icon-tag"></i> <a class="article-tag-none-link" href="/tags/matlab/" rel="tag">matlab</a> </span><span class="_partial/post-comment"><i class="icon icon-comment"></i> <a href="/matlab-mdce-log/#comments" class="article-comment-link">Comments </a></span><span class="post-wordcount" itemprop="wordCount">Word Count: 1.4k(words)</span> <span class="post-readcount" itemprop="timeRequired">Read Count: 5(minutes)</span></p></header><div class="marked-body article-body"><p><strong>本篇的内容可能过时啦</strong></p><p>虽然我很久不用MATLAB处理日常工作，但是实验室主流依然是MATLAB（用Python的就那么几个T_T)。以前小伙伴们跑程序都是拷贝程序和数据到实验室的计算服务器上，手工开N个MATLAB窗口做运算。现在实验室规模扩大，这种手工的方式越来越繁琐。我从前用MATLAB时就想试试集群计算，奈何当时实验室没啥硬件条件，正好现在有机会，我干脆搭了个MATLAB集群供小伙伴使用。<span id="more"></span></p><h2 id="软硬件">软硬件</h2><p>硬件方面：</p><ul><li>4核心, 16GB内存， 百兆网卡普通台式机(manage节点)</li><li>40核心, 128GB内存, 千兆网卡计算服务器(compute1节点)</li><li>346TB存储， 千兆网卡存储服务器(storage节点)</li></ul><p>软件方面：</p><ul><li>Windows10专业版系统</li><li>centos7</li><li>matlab2017b</li></ul><p>网络环境：</p><ul><li>192.168.130.12(matlab-manage.xxx.org) – manage节点</li><li>192.168.130.11(matlab-compute1.xxx.org) – compute1节点</li><li>192.168.130.10 – storage节点</li></ul><p>MATLAB的帮助文档中提出，想要使用集群计算服务应该满足以下条件：</p><ul><li>推荐一个CPU核心最多创建一个worker</li><li>推荐每个worker最少可以使用2GB内存</li><li>最少5GB的硬盘空间容纳暂时性的数据文件</li><li>计算集群之间应当使用同构的计算架构(要求计算节点的硬件配置、系统和软件配置一致)</li></ul><h2 id="集群安装配置">集群安装配置</h2><h3 id="ip域名设置">ip域名设置</h3><p>修改compute节点和manage节点的计算机名、ip地址以及DNS域名解析，例如compute1节点的计算机名为matlab-compute1.xxx.org(xxx.org为后缀域名)，DNS域名也应该为matlab-compute1.xxx.org，ip地址为192.168.130.11。</p><blockquote><p>MATLAB分布式计算服务似乎要求计算机名要添加后缀域名(xxx.org)，否则在集群测试时会有解析不匹配的警告，Windows专业版可在<strong>这台电脑-属性-更改设置-更改-其他</strong>中添加主DNS后缀。</p></blockquote><h3 id="manage节点">manage节点</h3><p>在manage节点安装matlab2017b，manage节点在安装过程中应该勾选MATLAB License Server和MATLAB Distributed Computing Server工具箱，前者为集群提供license认证服务，后者是分布式计算的核心服务组件。对于破解版的MATLAB，应该输入floating license的key而不是standalone的key，才能安装MATLAB License Server。安装完毕（并破解）后，在Windows服务选项卡中启动MATLAB License Server服务。</p><img src="/matlab-mdce-log/license.png"><p>同时修改C:\Program Files\MATLAB\R2017b\licenses\network.lic为如下内容</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SERVER this_host ANY</span><br><span class="line">USE_SERVER</span><br></pre></td></tr></table></figure><p>修改C:\Program Files\MATLAB\R2017b\toolbox\distcomp\bin\mdce_def.bat其中的security level为2</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set SECURITY_LEVEL=2</span><br></pre></td></tr></table></figure><blockquote><p>设置security level为2的效果是要求用户在使用分布式计算服务时输入用户名，从而可以监控集群使用情况。</p></blockquote><p>启动MATLAB，切换到C:\Program Files\MATLAB\R2017b\toolbox\distcomp\bin目录下，在MATLAB命令行窗口输入如下命令安装并启动mdce服务</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!mdce install </span><br><span class="line">!mdce start</span><br></pre></td></tr></table></figure><blockquote><p>最好在MATLAB命令行窗口内启动mdce服务，如果在Windows服务选项卡中启动服务，会出现权限问题导致集群worker无法连接。</p></blockquote><p>启动mdce服务后最好双击运行C:\Program Files\MATLAB\R2017b\toolbox\distcomp\bin\addMatlabToWindowsFirewall.bat文件（我的做法是直接关闭Windows防火墙避免多余的问题）</p><h3 id="compute节点">compute节点</h3><p>compute节点的安装配置同manage节点，仅以下内容不同</p><ol><li>安装matlab时无需勾选MATLAB License Server工具箱</li><li>修改C:\Program Files\MATLAB\R2017b\licenses\network.lic为如下内容</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SERVER matlab-manage.xxx.org ANY</span><br><span class="line">USE_SERVER</span><br></pre></td></tr></table></figure><p>此外为了跟storage节点连接，compute节点需要安装NFS服务，在<strong>程序和功能-启用或关闭Windows功能</strong>中勾选NFS服务</p><img src="/matlab-mdce-log/nfs.png"><h2 id="storage节点">storage节点</h2><p>storage节点设置NFS服务，NFS服务端安装和配置网上都有，我就不写了。</p><h3 id="添加集群节点">添加集群节点</h3><p>在manage节点运行C:\Program Files\MATLAB\R2017b\toolbox\distcomp\bin\admincenter.bat，启动管理面板，点击<strong>Add or Find</strong>，添加manage节点和compute1节点，添加完毕后，点击<strong>Test Connectivity</strong>，测试通过如下图</p><img src="/matlab-mdce-log/connectivity.png"><p>在MATLAB Job Scheduler面板点击start启动scheduler，输入名称，选择scheduler的节点为matlab-manage.xxx.org，因为security level为2，还需要设置管理员的密码。</p><p>设置好scheduler后，右键scheduler点击Start Workers，勾选compute1节点，设置启动的worker数量（我只有40个核心，所以启动40个worker）。</p><img src="/matlab-mdce-log/center.png"><h3 id="客户端配置和使用">客户端配置和使用</h3><p>MATLAB集群计算要求客户端的matlab版本和服务端一致，因为我服务端安装的是2017b，客户端也应该是matlab2017b。客户端可以选择standalone安装方式，也需要安装mdce服务添加防火墙配置并启动。<br>如果客户端想直接使用NFS服务，也需要在<strong>程序和功能-启用或关闭Windows功能</strong>中勾选NFS服务。<br>安装完毕后，在MATLAB主页中的<strong>Parallel</strong>选项选择<strong>Discover Cluster</strong>，勾选<strong>On your network</strong>，点击Next等待发现集群mjs40_2，选择集群，点击Next，Finish，就可以使用集群了，集群的使用情况可以在<strong>Parallel</strong>选项里<strong>Monitor Jobs</strong>查看。</p><p>这里提供两个matlab并行计算脚本检测集群配置是否正确</p><figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line"><span class="comment">%This demo shows how to use distributed computing server</span></span><br><span class="line"></span><br><span class="line">primeNumbers = <span class="built_in">primes</span>(uint64(<span class="number">2</span>^<span class="number">21</span>));</span><br><span class="line">compositeNumbers = primeNumbers.*primeNumbers(randperm(<span class="built_in">numel</span>(primeNumbers)));</span><br><span class="line">factors = <span class="built_in">zeros</span>(<span class="built_in">numel</span>(primeNumbers),<span class="number">2</span>);</span><br><span class="line">tic;</span><br><span class="line"><span class="keyword">parfor</span> idx = <span class="number">1</span>:<span class="built_in">numel</span>(compositeNumbers)</span><br><span class="line">    factors(idx,:) = <span class="built_in">factor</span>(compositeNumbers(idx));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">toc</span><br></pre></td></tr></table></figure><figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line"><span class="comment">%This demo shows how to load data from nfs server, target_folder is nfs server ip address</span></span><br><span class="line"></span><br><span class="line">target_folder=<span class="string">&#x27;\\192.168.130.10\pub\data\&#x27;</span>;</span><br><span class="line">factors=<span class="built_in">zeros</span>(<span class="number">400</span>,<span class="number">2</span>);</span><br><span class="line">tic;</span><br><span class="line"><span class="keyword">parfor</span> <span class="built_in">i</span>=<span class="number">0</span>:<span class="number">399</span></span><br><span class="line">    tmp = load([target_folder,num2str(<span class="built_in">i</span>),<span class="string">&#x27;.mat&#x27;</span>]);</span><br><span class="line">    data = tmp.data;</span><br><span class="line">    factors(<span class="built_in">i</span>+<span class="number">1</span>, :)=<span class="built_in">factor</span>(data);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">toc</span><br></pre></td></tr></table></figure></div><blockquote class="copyright"><p><strong>Link to this article : </strong><a class="permalink" href="https://mrswolf.github.io/matlab-mdce-log/">https://mrswolf.github.io/matlab-mdce-log/</a></p><p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p></blockquote></article></main><aside id="sidebar" class="aside aside-fixture"><div class="toc-sidebar"><nav id="toc" class="article-toc"><h3 class="toc-title">Catalogue</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E7%A1%AC%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">软硬件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">集群安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ip%E5%9F%9F%E5%90%8D%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">ip域名设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#manage%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">manage节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compute%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.</span> <span class="toc-text">compute节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#storage%E8%8A%82%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">storage节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">添加集群节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">客户端配置和使用</span></a></li></ol></li></ol></nav></div></aside></section><footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40"><div class="footer-social-links"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont icon-github"></i> </a><a href="/atom.xml"><i class="iconfont icon-rss"></i></a></div></footer><div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div><div id="search-view-container" class="hidden shadow-xl"></div><script src="/js/dom-event.min.js"></script><script src="/js/local-search.min.js"></script><script src="//cdn.staticfile.org/lightgallery-js/1.1.3/js/lightgallery.min.js"></script><script src="/js/light-gallery.min.js"></script></body></html>