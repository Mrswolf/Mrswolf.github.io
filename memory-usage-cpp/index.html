<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=5,viewport-fit=cover"><title>How to Measure Memory Usage in C++ | swolf's blog</title><meta name="description" content="I’ve been struggling with calculating the memory usage for a week. Here’s the case: I got a program that needs to estimate how much memory it may consume during runtime with some predefined inputs, s"><meta property="og:type" content="article"><meta property="og:title" content="How to Measure Memory Usage in C++"><meta property="og:url" content="https://mrswolf.github.io/memory-usage-cpp/index.html"><meta property="og:site_name" content="swolf&#39;s blog"><meta property="og:description" content="I’ve been struggling with calculating the memory usage for a week. Here’s the case: I got a program that needs to estimate how much memory it may consume during runtime with some predefined inputs, s"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2024-01-24T16:00:00.000Z"><meta property="article:modified_time" content="2024-01-24T16:00:00.000Z"><meta property="article:author" content="swolf"><meta property="article:tag" content="脑机接口,神经科学,机器学习,swolf,计算机,脑科学,Python,深度学习,BCI,MRI,Deep Learning"><meta name="twitter:card" content="summary"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><meta name="google-site-verification" content="dN2SLd9-x4zqC5VsgpROSppupvj3_eOvkDfKG32YSdc"><link rel="stylesheet" href="/css/iconfont.min.css"><link rel="stylesheet" href="/css/common.min.css"><link href="//cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css" rel="stylesheet" crossorigin="anonymous"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2JPFK1G1RZ"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2JPFK1G1RZ")</script><meta name="generator" content="Hexo 6.3.0"></head><body><header class="header header-fixture"><div class="profile-search-wrap flex sm:block"><div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6"><a id="avatar" role="link" href="https://mrswolf.github.io" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer"><img src="/images/avatar.jpg" class="rounded-full" alt="avatar"></a><h2 id="name" class="hidden lg:block">swolf</h2><h3 id="title" class="hidden lg:block">Engineer &amp; Coder &amp; Researcher</h3><small id="location" class="hidden lg:block"><i class="iconfont icon-map-icon"></i> Earth, Universe</small></div><div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full"><form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200"><div class="input-group table bg-gray-100 lg:bg-white w-full"><input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white p-1"> <span class="table-cell"><button name="search tigger button" disabled><i class="iconfont icon-search m-2"></i></button></span></div></form><div id="content-json" data-placeholder="Search" class="invisible hidden">/content.json</div><script id="search-teamplate" type="text/html" data-path="/content.json"><div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div></script></div><button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false"><i class="iconfont icon-hamburger"></i></button></div><nav id="menu-nav" class="hidden sm:flex flex-col"><div class="menu-item menu-home" role="menuitem"><a href="/."><i class="iconfont icon-home" aria-hidden="true"></i> <span class="menu-title">Home</span></a></div><div class="menu-item menu-archives" role="menuitem"><a href="/archives"><i class="iconfont icon-archive" aria-hidden="true"></i> <span class="menu-title">Archives</span></a></div><div class="menu-item menu-categories" role="menuitem"><a href="/categories"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Categories</span></a></div><div class="menu-item menu-tags" role="menuitem"><a href="/tags"><i class="iconfont icon-tag" aria-hidden="true"></i> <span class="menu-title">Tags</span></a></div><div class="menu-item menu-repository" role="menuitem"><a href="/repository"><i class="iconfont icon-project" aria-hidden="true"></i> <span class="menu-title">Repository</span></a></div><div class="menu-item menu-publications" role="menuitem"><a href="/publications"><i class="iconfont icon-folder" aria-hidden="true"></i> <span class="menu-title">Publications</span></a></div><div class="menu-item menu-about" role="menuitem"><a href="/about"><i class="iconfont icon-cup" aria-hidden="true"></i> <span class="menu-title">About</span></a></div><div class="social-links flex sm:flex-col lg:hidden mt-5"><span class="social-item text-center"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont social-icon icon-github"></i> <span class="menu-title hidden lg:inline">menu.github</span> </a></span><span class="social-item text-center"><a href="/atom.xml"><i class="iconfont social-icon icon-rss"></i> <span class="menu-title hidden lg:inline">menu.rss</span></a></span></div></nav></header><section class="main-section"><main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen"><article class="content article article-archives article-type-list" itemscope><header class="article-header"><h1 itemprop="name text-lg"><a class="article-title" href="/memory-usage-cpp" target="_blank" itemprop="url">How to Measure Memory Usage in C++</a></h1><p class="article-meta mb-3 text-xs"><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2024-01-24T16:00:00.000Z" itemprop="datePublished">Jan25, 2024</time></span><span class="article-date"><i class="iconfont icon-calendar-check"></i><time datetime="2024-01-24T16:00:00.000Z" itemprop="datePublished">Jan25, 2024</time></span><span class="article-category"><i class="iconfont icon-folder"></i> <a class="article-category-link" href="/categories/cpp/">cpp</a> </span><span class="_partial/post-comment"><i class="icon icon-comment"></i> <a href="/memory-usage-cpp/#comments" class="article-comment-link">Comments </a></span><span class="post-wordcount" itemprop="wordCount">Word Count: 489(words)</span> <span class="post-readcount" itemprop="timeRequired">Read Count: 3(minutes)</span></p></header><div class="marked-body article-body"><p>I’ve been struggling with calculating the memory usage for a week. Here’s the case: I got a program that needs to estimate how much memory it may consume during runtime with some predefined inputs, such as the size of images, etc. The problem is that the program is so complicated that nearly no one understands the code fully. Not to mention, there are lots of parallel codes in the program, scaling the memory usage by the dynamic number of threads. <span id="more"></span></p><h2 id="getrusage">getrusage</h2><p>I really need a way to measure the memory usage of each function, so I googled it and found <a target="_blank" rel="noopener" href="https://youtu.be/Os5cK0H8EOA?si=kQ9j6nD6iHn_b7Pq">Jacob’s video</a> talking about <code>getrusage</code> function. According to the <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/getrusage.2.html">document</a>, this function returns mulitple resource usage measures for the calling process, the calling thread or all children of the calling process that have terminated and been waited for. The memory measure is defined in the field <code>ru_maxrss</code> of struct <code>rusage</code>, which denotes the maximum resident set size (nearly the amount of memory used) in kilobytes. Here’s the code I learned from the Jacob’s video:</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">get_mem_usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rusage</span> usage;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    ret = <span class="built_in">getrusage</span>(RUSAGE_SELF, &amp;usage);</span><br><span class="line">    <span class="keyword">return</span> usage.ru_maxrss; <span class="comment">// in KB</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">long</span> currentMem = <span class="built_in">get_mem_usage</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *p = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">1024</span> * <span class="number">100</span>);</span><br><span class="line">        std::<span class="built_in">memset</span>(p, <span class="number">1</span>, <span class="number">1024</span> * <span class="number">100</span>);</span><br><span class="line">        std::<span class="built_in">printf</span>(<span class="string">&quot;usage: %ld + %ld\n&quot;</span>, currentMem, <span class="built_in">get_mem_usage</span>() - currentMem);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The output was quite different from what Jacob got in the video. I got memory usage ranges from 6856KB to 7016KB. I did allocate 100 KB for 100 times, 10000KB totally. So, what happened?</p><p>Well, Jacob mentioned some compiler optimizations that the compiler may not allocate memory if it’s not used. However, it couldn’t explain my results here. I found <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/30940/getrusage-system-call-what-is-maximum-resident-set-size">this answer</a> on stackexchange, which says:</p><blockquote><p>For instance, if a process allocates a chunk of memory (say 100Mb) and uses it actively (reads/writes to it), its resident set size will be about 100Mb (plus overhead, the code segment, etc.). If after the process then stops using (but doesn’t release) that memory for a while, the OS could opt to swap chunks of that memory to swap, to make room for other processes (or cache). The resident set size would then decrease by the amount the kernel swapped out. If the process wakes up and starts re-using that memory, the kernel would re-load the data from swap, and the resident set size would go up again.</p></blockquote><p>Sounds reasonable, isn’t it? I changed my code and allocated 1MB for 100 times, 100MB totally. This time the memory usage was about 97.33MB. So, just remember that <code>getrusage</code> may be affected by many factors, and the values it returns may not correspond precisely to the theoretical values.</p></div><blockquote class="copyright"><p><strong>Link to this article : </strong><a class="permalink" href="https://mrswolf.github.io/memory-usage-cpp/">https://mrswolf.github.io/memory-usage-cpp/</a></p><p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p></blockquote></article></main><aside id="sidebar" class="aside aside-fixture"><div class="toc-sidebar"><nav id="toc" class="article-toc"><h3 class="toc-title">Catalogue</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#getrusage"><span class="toc-number">1.</span> <span class="toc-text">getrusage</span></a></li></ol></nav></div></aside></section><footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40"><div class="footer-social-links"><a target="_blank" rel="noopener" href="https://github.com/mrswolf"><i class="iconfont icon-github"></i> </a><a href="/atom.xml"><i class="iconfont icon-rss"></i></a></div></footer><div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div><div id="search-view-container" class="hidden shadow-xl"></div><script src="/js/dom-event.min.js"></script><script src="/js/local-search.min.js"></script><script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script><script src="/js/light-gallery.min.js"></script></body></html>